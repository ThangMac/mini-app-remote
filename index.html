<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini App - Ti·ªán √çch</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            padding: 1rem; 
            background: #f5f5f5;
        }
        .container { 
            max-width: 600px; 
            margin: auto; 
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #0ea5e9;
            font-size: 24px;
            margin-bottom: 10px;
        }
        p {
            color: #666;
            font-size: 14px;
        }
        button { 
            display: block; 
            width: 100%; 
            padding: 15px; 
            margin-bottom: 10px; 
            font-size: 16px;
            background: #0ea5e9;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:active {
            opacity: 0.7;
            transform: scale(0.98);
        }
        h3 {
            color: #333;
            font-size: 18px;
            margin-top: 30px;
            margin-bottom: 15px;
        }
        pre { 
            background-color: #f4f4f4; 
            padding: 15px; 
            border-radius: 8px; 
            white-space: pre-wrap; 
            word-wrap: break-word;
            font-size: 13px;
            color: #333;
            border: 1px solid #e0e0e0;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        
        /* Avatar View Styles */
        .avatar-section {
            margin: 20px 0;
            text-align: center;
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
            border: 2px dashed #d1d5db;
        }
        .avatar-container {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto 15px;
        }
        .avatar-image {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #0ea5e9;
            background: #e5e7eb;
            display: none;
        }
        .avatar-image.loaded {
            display: block;
        }
        .avatar-placeholder {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            color: white;
            border: 4px solid #d1d5db;
        }
        .avatar-placeholder.hidden {
            display: none;
        }
        .avatar-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }
        .avatar-loading.active {
            display: block;
        }
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #0ea5e9;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        .avatar-info {
            font-size: 14px;
            color: #6b7280;
            margin-top: 10px;
        }
        .avatar-info strong {
            color: #374151;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Mini App</h1>
        <p>ƒê√¢y l√† mini app ch·∫°y t·ª´ iOS assets th√¥ng qua WebView.</p>
        
        <!-- Avatar Section -->
        <div class="avatar-section">
            <div class="avatar-container">
                <div id="avatarPlaceholder" class="avatar-placeholder">üë§</div>
                <img id="avatarImage" class="avatar-image" alt="Avatar">
                <div id="avatarLoading" class="avatar-loading">
                    <div class="spinner"></div>
                </div>
            </div>
            <div id="avatarInfo" class="avatar-info">Ch∆∞a c√≥ avatar</div>
        </div>
        
        <button onclick="getAuthToken()">1. L·∫•y Token ƒê·ªãnh danh (SSO)</button>
        <button onclick="requestPayment()">2. Y√™u c·∫ßu Thanh to√°n ƒê∆°n l·∫ª (Dialog Legacy)</button>
        <button onclick="requestPaymentFullscreen()">3. Y√™u c·∫ßu Thanh to√°n To√†n m√†n h√¨nh</button>
        <button onclick="requestPaymentFailed()">4. Y√™u c·∫ßu Thanh to√°n ƒê∆°n l·∫ª (M√¥ ph·ªèng FAILED)</button>
        <button onclick="requestBatchPayment()">5. Y√™u c·∫ßu Thanh to√°n theo L√¥ (Chi l∆∞∆°ng)</button>
        <button onclick="pickAvatar()">6. Ch·ªçn Avatar</button>
        <button onclick="callPublicAPI()">7. G·ªçi Public API (Th·ªùi ti·∫øt Open‚ÄëMeteo)</button>

        <h3>K·∫øt qu·∫£ t·ª´ Shell App:</h3>
        <pre id="result">Ch∆∞a c√≥ d·ªØ li·ªáu...</pre>
    </div>

    <script>
        const resultEl = document.getElementById("result");

        // Check SuperApp Bridge availability
        if (!window.SuperApp) {
            resultEl.textContent = "‚ùå L·ªói: SuperApp Bridge kh√¥ng kh·∫£ d·ª•ng!\nMini app ph·∫£i ch·∫°y trong SuperApp.";
        } else {
            resultEl.textContent = "‚úÖ SuperApp Bridge s·∫µn s√†ng!\nVersion: " + window.SuperApp.version;
        }

        // H√†m n√†y s·∫Ω ƒë∆∞·ª£c g·ªçi b·ªüi Shell App sau khi thanh to√°n ho√†n t·∫•t
        window.onPaymentResult = function(result) {
            resultEl.textContent = `‚úÖ Thanh to√°n ho√†n t·∫•t:\n${JSON.stringify(result, null, 2)}`;
        }

        // --- C√°c h√†m g·ªçi xu·ªëng SuperApp qua Bridge ---

        async function getAuthToken() {
            resultEl.textContent = "‚è≥ ƒêang l·∫•y Token SSO...";
            try {
                if (window.SuperApp) {
                    // Get user info from SuperApp
                    const userInfo = await window.SuperApp.getUserInfo();
                    
                    // Mock JWT token (trong th·ª±c t·∫ø s·∫Ω call API backend)
                    const mockToken = btoa(JSON.stringify({
                        userId: userInfo.id,
                        email: userInfo.email,
                        appKey: "MISA_SME_MINI_KEY",
                        timestamp: Date.now(),
                        expiresIn: 3600
                    }));
                    
                    resultEl.innerHTML = `<span class="success">‚úÖ Nh·∫≠n ƒë∆∞·ª£c JWT Token:</span>\n\n<strong>User Info:</strong>\n${JSON.stringify(userInfo, null, 2)}\n\n<strong>Mock Token:</strong>\n${mockToken}`;
                } else {
                    resultEl.innerHTML = '<span class="error">‚ùå L·ªói: SuperApp Bridge kh√¥ng t·ªìn t·∫°i.</span>';
                }
            } catch (error) {
                resultEl.innerHTML = `<span class="error">‚ùå L·ªói: ${error}</span>`;
            }
        }

        async function requestPayment() {
            resultEl.textContent = "‚è≥ ƒêang g·ªçi requestPayment...";
            try {
                if (window.SuperApp) {
                    // Call SuperApp payment API
                    const result = await window.SuperApp.pay({
                        amount: 500000,
                        currency: 'VND',
                        orderId: `ORD-${Date.now()}`,
                        description: 'Thanh to√°n ƒë∆°n h√†ng',
                        method: 'dialog'
                    });
                    
                    resultEl.innerHTML = `<span class="success">‚úÖ Thanh to√°n th√†nh c√¥ng!</span>\n\n${JSON.stringify(result, null, 2)}`;
                } else {
                    resultEl.innerHTML = '<span class="error">‚ùå L·ªói: SuperApp Bridge kh√¥ng t·ªìn t·∫°i.</span>';
                }
            } catch (error) {
                resultEl.innerHTML = `<span class="error">‚ùå L·ªói: ${error}</span>`;
            }
        }

        async function requestPaymentFullscreen() {
            resultEl.textContent = "‚è≥ ƒêang m·ªü m√†n h√¨nh thanh to√°n to√†n m√†n h√¨nh...";
            try {
                if (window.SuperApp) {
                    const result = await window.SuperApp.pay({
                        amount: 1000000,
                        currency: 'VND',
                        orderId: `ORD-FULL-${Date.now()}`,
                        description: 'Thanh to√°n to√†n m√†n h√¨nh',
                        method: 'fullscreen'
                    });
                    
                    resultEl.innerHTML = `<span class="success">‚úÖ Thanh to√°n to√†n m√†n h√¨nh th√†nh c√¥ng!</span>\n\n${JSON.stringify(result, null, 2)}`;
                } else {
                    resultEl.innerHTML = '<span class="error">‚ùå L·ªói: SuperApp Bridge kh√¥ng t·ªìn t·∫°i.</span>';
                }
            } catch (error) {
                resultEl.innerHTML = `<span class="error">‚ùå L·ªói: ${error}</span>`;
            }
        }

        async function requestPaymentFailed() {
            resultEl.textContent = "‚è≥ ƒêang g·ªçi requestPayment (m√¥ ph·ªèng FAILED)...";
            try {
                if (window.SuperApp) {
                    // Mock failed payment
                    const mockResult = {
                        success: false,
                        errorCode: 'PAYMENT_CANCELLED',
                        message: 'Ng∆∞·ªùi d√πng ƒë√£ h·ªßy thanh to√°n',
                        orderId: `ORD-FAIL-${Date.now()}`
                    };
                    
                    resultEl.innerHTML = `<span class="error">‚ùå Thanh to√°n th·∫•t b·∫°i!</span>\n\n${JSON.stringify(mockResult, null, 2)}`;
                } else {
                    resultEl.innerHTML = '<span class="error">‚ùå L·ªói: SuperApp Bridge kh√¥ng t·ªìn t·∫°i.</span>';
                }
            } catch (error) {
                resultEl.innerHTML = `<span class="error">‚ùå L·ªói: ${error}</span>`;
            }
        }

        async function requestBatchPayment() {
            resultEl.textContent = "‚è≥ ƒêang g·ªçi requestBatchPayment...";
            try {
                if (window.SuperApp) {
                    const payments = [
                        { amount: 15000000, toAccount: "123456", name: "Nguyen Van A" },
                        { amount: 18000000, toAccount: "789012", name: "Tran Thi B" },
                        { amount: 12000000, toAccount: "345678", name: "Le Van C" }
                    ];
                    
                    // Call SuperApp payment API for batch
                    const result = await window.SuperApp.pay({
                        type: 'batch',
                        payments: payments,
                        batchId: `BATCH-${Date.now()}`,
                        totalAmount: payments.reduce((sum, p) => sum + p.amount, 0),
                        description: 'Chi l∆∞∆°ng th√°ng 10/2024'
                    });
                    
                    resultEl.innerHTML = `<span class="success">‚úÖ Y√™u c·∫ßu chi l∆∞∆°ng theo l√¥ th√†nh c√¥ng!</span>\n\n${JSON.stringify(result, null, 2)}`;
                } else {
                    resultEl.innerHTML = '<span class="error">‚ùå L·ªói: SuperApp Bridge kh√¥ng t·ªìn t·∫°i.</span>';
                }
            } catch (error) {
                resultEl.innerHTML = `<span class="error">‚ùå L·ªói: ${error}</span>`;
            }
        }

        async function pickAvatar() {
            // Get avatar elements
            const avatarImage = document.getElementById('avatarImage');
            const avatarPlaceholder = document.getElementById('avatarPlaceholder');
            const avatarLoading = document.getElementById('avatarLoading');
            const avatarInfo = document.getElementById('avatarInfo');
            
            // Show loading state
            avatarLoading.classList.add('active');
            avatarPlaceholder.classList.add('hidden');
            avatarImage.classList.remove('loaded');
            avatarInfo.textContent = 'ƒêang m·ªü th∆∞ vi·ªán ·∫£nh...';
            resultEl.textContent = "‚è≥ ƒêang m·ªü th∆∞ vi·ªán ·∫£nh...";
            
            try {
                if (window.SuperApp) {
                    // Call SuperApp photo picker
                    const result = await window.SuperApp.pickImage();
                    
                    // Hide loading
                    avatarLoading.classList.remove('active');
                    
                    if (result.success) {
                        const img = result.image;
                        
                        // Update avatar image
                        avatarImage.src = `data:${img.mimeType};base64,${img.base64}`;
                        avatarImage.classList.add('loaded');
                        
                        // Update avatar info
                        avatarInfo.innerHTML = `
                            <strong>‚úÖ Avatar ƒë√£ c·∫≠p nh·∫≠t</strong><br>
                            ${(img.size / 1024).toFixed(2)} KB ‚Ä¢ ${img.width} x ${img.height}px
                        `;
                        
                        // Display result with image preview in result box
                        resultEl.innerHTML = `
                            <div style="padding: 15px; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 10px;">
                                <h4 style="margin: 0 0 10px 0; color: #0c4a6e;">‚úÖ ƒê√£ ch·ªçn ·∫£nh th√†nh c√¥ng!</h4>
                                <img src="data:${img.mimeType};base64,${img.base64}" 
                                     style="max-width: 200px; height: auto; border-radius: 8px; margin: 10px 0; display: block; border: 2px solid #0ea5e9;"
                                     alt="Selected Avatar">
                                <p style="margin: 5px 0; color: #0c4a6e;">
                                    <strong>K√≠ch th∆∞·ªõc:</strong> ${(img.size / 1024).toFixed(2)} KB<br>
                                    <strong>ƒê·ªô ph√¢n gi·∫£i:</strong> ${img.width} x ${img.height}px<br>
                                    <strong>ƒê·ªãnh d·∫°ng:</strong> ${img.mimeType}
                                </p>
                            </div>
                        `;
                        
                        // Save to storage (save full image data)
                        await window.SuperApp.storage.set('selectedAvatar', JSON.stringify(img));
                        
                        // Show toast
                        window.SuperApp.showToast('Avatar ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t! ‚ú®');
                        
                    } else {
                        // User cancelled - restore placeholder
                        avatarPlaceholder.classList.remove('hidden');
                        avatarInfo.textContent = 'Kh√¥ng c√≥ ·∫£nh n√†o ƒë∆∞·ª£c ch·ªçn';
                        resultEl.innerHTML = '<span class="warning">‚ö†Ô∏è Kh√¥ng c√≥ ·∫£nh n√†o ƒë∆∞·ª£c ch·ªçn</span>';
                    }
                } else {
                    avatarLoading.classList.remove('active');
                    avatarPlaceholder.classList.remove('hidden');
                    avatarInfo.textContent = 'L·ªói: SuperApp Bridge kh√¥ng t·ªìn t·∫°i';
                    resultEl.innerHTML = '<span class="error">‚ùå L·ªói: SuperApp Bridge kh√¥ng t·ªìn t·∫°i.</span>';
                }
            } catch (error) {
                // Error - restore placeholder
                avatarLoading.classList.remove('active');
                avatarPlaceholder.classList.remove('hidden');
                avatarInfo.textContent = 'L·ªói khi ch·ªçn ·∫£nh';
                resultEl.innerHTML = `<span class="error">‚ùå L·ªói: ${error}</span>`;
                if (window.SuperApp) {
                    window.SuperApp.showAlert('L·ªói', 'Kh√¥ng th·ªÉ ch·ªçn ·∫£nh: ' + error);
                }
            }
        }

        async function callPublicAPI() {
            resultEl.textContent = "‚è≥ ƒêang g·ªçi API th·ªùi ti·∫øt...";
            try {
                if (window.SuperApp) {
                    // Call Open-Meteo API for weather in Hanoi
                    const result = await window.SuperApp.request({
                        url: 'https://api.open-meteo.com/v1/forecast?latitude=21.0285&longitude=105.8542&current_weather=true',
                        method: 'GET'
                    });
                    
                    // Parse response.data correctly (SuperApp returns {data: ..., status: ...})
                    let data;
                    if (result && result.data) {
                        // Parse the data field
                        if (typeof result.data === 'string') {
                            data = JSON.parse(result.data);
                        } else {
                            data = result.data;
                        }
                    } else {
                        // Fallback to direct result
                        data = typeof result === 'string' ? JSON.parse(result) : result;
                    }
                    
                    if (data && data.current_weather) {
                        const weather = data.current_weather;
                        resultEl.innerHTML = `<span class="success">‚úÖ Th·ªùi ti·∫øt H√† N·ªôi:</span>\nüå°Ô∏è Nhi·ªát ƒë·ªô: ${weather.temperature}¬∞C\nüí® T·ªëc ƒë·ªô gi√≥: ${weather.windspeed} km/h\nüß≠ H∆∞·ªõng gi√≥: ${weather.winddirection}¬∞\n‚è∞ Th·ªùi gian: ${weather.time}\n\n<strong>Raw Data:</strong>${JSON.stringify(data, null, 2)}`;
                    } else {
                        resultEl.innerHTML = `<span class="success">‚úÖ API Response:</span>\n${JSON.stringify(result, null, 2)}`;
                    }
                } else {
                    resultEl.innerHTML = '<span class="error">‚ùå L·ªói: SuperApp Bridge kh√¥ng t·ªìn t·∫°i.</span>';
                }
            } catch (error) {
                resultEl.innerHTML = `<span class="error">‚ùå L·ªói: ${error}</span>`;
            }
        }

        // Load saved avatar on startup
        window.addEventListener('load', async () => {
            try {
                if (window.SuperApp) {
                    const savedData = await window.SuperApp.storage.get('selectedAvatar');
                    if (savedData) {
                        try {
                            // Parse saved avatar data (savedData is already unwrapped)
                            const img = JSON.parse(savedData);
                            
                            // Get avatar elements
                            const avatarImage = document.getElementById('avatarImage');
                            const avatarPlaceholder = document.getElementById('avatarPlaceholder');
                            const avatarInfo = document.getElementById('avatarInfo');
                            
                            // Update avatar UI
                            avatarImage.src = `data:${img.mimeType};base64,${img.base64}`;
                            avatarImage.classList.add('loaded');
                            avatarPlaceholder.classList.add('hidden');
                            
                            // Update avatar info
                            avatarInfo.innerHTML = `
                                <strong>‚úÖ Avatar ƒë√£ l∆∞u</strong><br>
                                ${(img.size / 1024).toFixed(2)} KB ‚Ä¢ ${img.width} x ${img.height}px
                            `;
                            
                            console.log('‚úÖ Loaded saved avatar from storage');
                        } catch (parseError) {
                            console.log('‚ùå Error parsing saved avatar:', parseError);
                        }
                    } else {
                        console.log('‚ÑπÔ∏è No saved avatar found');
                    }
                }
            } catch (error) {
                console.log('‚ÑπÔ∏è No saved avatar or error loading:', error);
            }
        });
    </script>
</body>
</html>


